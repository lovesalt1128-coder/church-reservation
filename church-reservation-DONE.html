<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµíšŒ ì¥ì†Œ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .setup-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 30px;
            margin: 30px;
            border-radius: 15px;
        }

        .setup-box h2 {
            color: #856404;
            margin-bottom: 20px;
        }

        .setup-box input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
        }

        .setup-box button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
        }

        .setup-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            padding: 30px;
        }

        .booking-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            height: fit-content;
        }

        .booking-form h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .schedule-view {
            background: #fff;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .building-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .building-tab {
            padding: 12px 30px;
            border: none;
            background: #f0f0f0;
            color: #666;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .building-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .room-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .room-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .room-btn.active {
            background: #667eea;
            color: white;
        }

        .timeline {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .time-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #666;
        }

        .time-slot {
            background: #f0f0f0;
            border-radius: 8px;
            padding: 15px;
            min-height: 60px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .time-slot:hover {
            background: #e8e8e8;
            border-color: #667eea;
        }

        .time-slot.booked {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: default;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .success {
            background: #4caf50;
            color: white;
        }

        .error {
            background: #f44336;
            color: white;
        }

        .admin-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            font-weight: 600;
            color: #667eea;
            z-index: 1000;
        }

        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .password-modal.active {
            display: flex;
        }

        .password-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }

        .password-box h3 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .password-box input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
        }

        .password-box button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .password-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .password-box .cancel-btn {
            background: #999;
        }

        .password-box .cancel-btn:hover {
            background: #777;
        }

        .password-error {
            color: #f44336;
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        .admin-view {
            display: none;
            padding: 30px;
        }

        .admin-view.active {
            display: block;
        }

        .main-content.hidden {
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .heatmap-building {
            margin-bottom: 40px;
        }

        .heatmap-building h4 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: 150px repeat(12, 1fr);
            gap: 4px;
            margin-bottom: 15px;
        }

        .heatmap-header {
            display: contents;
        }

        .heatmap-time {
            text-align: center;
            font-weight: 600;
            color: #667eea;
            font-size: 0.9em;
            padding: 8px 4px;
        }

        .heatmap-room-label {
            font-weight: 600;
            color: #333;
            padding: 12px 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.95em;
        }

        .heatmap-room-count {
            font-size: 0.85em;
            color: #667eea;
            background: white;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
        }

        .heatmap-cell.empty {
            background: #f0f0f0;
            border: 2px solid #e0e0e0;
        }

        .heatmap-cell.booked {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid #667eea;
            color: white;
            font-weight: 600;
        }

        .heatmap-cell.current {
            background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
            border: 2px solid #f44336;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .heatmap-cell.booked:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            z-index: 10;
        }

        .detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .detail-modal.active {
            display: flex;
        }

        .detail-box {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .detail-info {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .detail-info label {
            display: block;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .detail-info div {
            color: #333;
            font-size: 1.1em;
        }

        .detail-delete-btn {
            width: 100%;
            padding: 15px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }

        .detail-delete-btn:hover {
            background: #d32f2f;
        }

        @media (max-width: 1024px) {
            .heatmap-grid {
                grid-template-columns: 120px repeat(12, 1fr);
                gap: 2px;
            }
            .heatmap-room-label {
                font-size: 0.85em;
                padding: 8px 4px;
            }
            .heatmap-time {
                font-size: 0.8em;
            }
        }

        .bookings-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .bookings-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .bookings-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
        }

        .bookings-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .refresh-btn {
            padding: 10px 20px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .timeline {
                grid-template-columns: 60px 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="admin-toggle" id="adminToggle" onclick="showPasswordModal()">
        ğŸ‘¤ ê´€ë¦¬ì ëª¨ë“œ
    </div>

    <!-- Password Modal -->
    <div class="password-modal" id="passwordModal">
        <div class="password-box">
            <h3>ğŸ” ê´€ë¦¬ì ì¸ì¦</h3>
            <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" onkeypress="if(event.key==='Enter') checkPassword()">
            <button onclick="checkPassword()">í™•ì¸</button>
            <button class="cancel-btn" onclick="hidePasswordModal()">ì·¨ì†Œ</button>
            <div class="password-error" id="passwordError">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>ğŸ›ï¸ êµíšŒ ì¥ì†Œ ì˜ˆì•½ ì‹œìŠ¤í…œ</h1>
            <p>Google Sheets ì—°ë™ - ì‹¤ì‹œê°„ ê³µìœ </p>
        </header>

        <!-- Setup Box -->
        <div class="setup-box" id="setupBox" style="display: none;">
            <h2>âš™ï¸ Google Apps Script URL ì„¤ì •</h2>
            <input type="url" id="urlInput" placeholder="https://script.google.com/macros/s/.../exec">
            <button onclick="saveUrl()">ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°</button>
        </div>

        <!-- Admin View -->
        <div class="admin-view" id="adminView">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2>ğŸ“Š ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
                <button class="refresh-btn" onclick="loadData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="nowCount">0</h3>
                    <p>ğŸ”´ ì§€ê¸ˆ ì‚¬ìš© ì¤‘</p>
                </div>
                <div class="stat-card">
                    <h3 id="todayCount">0</h3>
                    <p>ğŸ“… ì˜¤ëŠ˜ ì˜ˆì•½</p>
                </div>
                <div class="stat-card">
                    <h3 id="weekCount">0</h3>
                    <p>ğŸ“ˆ ì´ë²ˆì£¼</p>
                </div>
            </div>

            <!-- Heatmap Section -->
            <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3 style="color: #667eea;">ğŸ“… ì˜¤ëŠ˜ ì˜ˆì•½ í˜„í™©</h3>
                    <input type="date" id="adminDate" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                </div>

                <div id="heatmapContainer"></div>
            </div>
        </div>

        <!-- Booking Detail Modal -->
        <div class="detail-modal" id="detailModal" onclick="hideDetailModal()">
            <div class="detail-box" onclick="event.stopPropagation()">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #667eea;">ğŸ“‹ ì˜ˆì•½ ìƒì„¸</h3>
                    <button onclick="hideDetailModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #999;">Ã—</button>
                </div>
                <div id="detailContent"></div>
            </div>
        </div>

        <!-- User View -->
        <div class="main-content" id="userView">
            <div class="booking-form">
                <h2>ğŸ“ ìƒˆ ì˜ˆì•½</h2>
                <div class="message success" id="successMsg"></div>
                <div class="message error" id="errorMsg"></div>
                
                <form id="bookingForm">
                    <div class="form-group">
                        <label>ì¥ì†Œ</label>
                        <select id="room" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <optgroup label="ğŸ›ï¸ êµíšŒ ë³¸ê´€">
                                <option value="ë³¸ê´€-ë³¸ë‹¹">ë³¸ë‹¹</option>
                                <option value="ë³¸ê´€-ìëª¨ì‹¤">ìëª¨ì‹¤</option>
                                <option value="ë³¸ê´€-êµíšŒì‹ë‹¹">êµíšŒ ì‹ë‹¹</option>
                                <option value="ë³¸ê´€-ì˜ì ‘ì‹¤">ì˜ì ‘ì‹¤(2-1êµì‹¤)</option>
                                <option value="ë³¸ê´€-ê¸°ë„ì‹¤">ê¸°ë„ì‹¤(2-2êµì‹¤)</option>
                                <option value="ë³¸ê´€-êµìœ¡ìœ„ì›íšŒì‹¤">êµìœ¡ìœ„ì›íšŒì‹¤</option>
                                <option value="ë³¸ê´€-2ì¸µì„¸ë¯¸ë‚˜ì‹¤">2ì¸µ ì„¸ë¯¸ë‚˜ì‹¤</option>
                                <option value="ë³¸ê´€-ì•…ê¸°ì—°ìŠµì‹¤">ì•…ê¸°ì—°ìŠµì‹¤</option>
                                <option value="ë³¸ê´€-ì˜ì•„ë¶€ì‹¤">ì˜ì•„ë¶€ì‹¤</option>
                            </optgroup>
                            <optgroup label="ğŸ¢ ì„¼í„°ìœ„ë“œ">
                                <option value="ì„¼í„°ìœ„ë“œ-ì§€í•˜ì½˜ì„œíŠ¸í™€">ì§€í•˜ ì½˜ì„œíŠ¸í™€</option>
                                <option value="ì„¼í„°ìœ„ë“œ-2ì¸µ">2ì¸µ</option>
                                <option value="ì„¼í„°ìœ„ë“œ-3ì¸µì„¸ë¯¸ë‚˜ì‹¤1">3ì¸µ ì„¸ë¯¸ë‚˜ì‹¤1</option>
                                <option value="ì„¼í„°ìœ„ë“œ-3ì¸µì„¸ë¯¸ë‚˜ì‹¤2">3ì¸µ ì„¸ë¯¸ë‚˜ì‹¤2</option>
                                <option value="ì„¼í„°ìœ„ë“œ-3ì¸µì„¸ë¯¸ë‚˜ì‹¤3">3ì¸µ ì„¸ë¯¸ë‚˜ì‹¤3</option>
                                <option value="ì„¼í„°ìœ„ë“œ-3ì¸µì„¸ë¯¸ë‚˜ì‹¤4">3ì¸µ ì„¸ë¯¸ë‚˜ì‹¤4</option>
                                <option value="ì„¼í„°ìœ„ë“œ-3ì¸µì„¸ë¯¸ë‚˜ì‹¤5">3ì¸µ ì„¸ë¯¸ë‚˜ì‹¤5</option>
                                <option value="ì„¼í„°ìœ„ë“œ-5ì¸µìœ ì¹˜ë¶€ì‹¤">5ì¸µ(ìœ ì¹˜ë¶€ì‹¤)</option>
                                <option value="ì„¼í„°ìœ„ë“œ-6ì¸µì´ˆë“±ë¶€ì‹¤">6ì¸µ(ì´ˆë“±ë¶€ì‹¤)</option>
                                <option value="ì„¼í„°ìœ„ë“œ-7ì¸µìœ ë…„ë¶€ì‹¤">7ì¸µ(ìœ ë…„ë¶€ì‹¤)</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ë‚ ì§œ</label>
                        <input type="date" id="date" required>
                    </div>

                    <div class="form-group">
                        <label>ì‹œê°„</label>
                        <select id="time" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="09:00">09:00 - 10:00</option>
                            <option value="10:00">10:00 - 11:00</option>
                            <option value="11:00">11:00 - 12:00</option>
                            <option value="12:00">12:00 - 13:00</option>
                            <option value="13:00">13:00 - 14:00</option>
                            <option value="14:00">14:00 - 15:00</option>
                            <option value="15:00">15:00 - 16:00</option>
                            <option value="16:00">16:00 - 17:00</option>
                            <option value="17:00">17:00 - 18:00</option>
                            <option value="18:00">18:00 - 19:00</option>
                            <option value="19:00">19:00 - 20:00</option>
                            <option value="20:00">20:00 - 21:00</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ì´ë¦„ / ë¶€ì„œëª…</label>
                        <input type="text" id="name" placeholder="í™ê¸¸ë™ / ì²­ë…„ë¶€" required>
                    </div>

                    <div class="form-group">
                        <label>ì—°ë½ì²˜</label>
                        <input type="tel" id="phone" placeholder="010-1234-5678" required>
                    </div>

                    <div class="form-group">
                        <label>ì‚¬ìš© ëª©ì </label>
                        <input type="text" id="purpose" placeholder="ì†Œê·¸ë£¹ ëª¨ì„">
                    </div>

                    <button type="submit" class="btn">ì˜ˆì•½í•˜ê¸°</button>
                </form>
            </div>

            <div class="schedule-view">
                <div class="schedule-header">
                    <h2>ğŸ“… ì˜ˆì•½ í˜„í™©</h2>
                    <button class="refresh-btn" onclick="loadData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>
                
                <div class="building-tabs">
                    <button class="building-tab active" onclick="switchBuilding('ë³¸ê´€')">ğŸ›ï¸ êµíšŒ ë³¸ê´€</button>
                    <button class="building-tab" onclick="switchBuilding('ì„¼í„°ìœ„ë“œ')">ğŸ¢ ì„¼í„°ìœ„ë“œ</button>
                </div>

                <div class="room-selector" id="roomSelector"></div>

                <input type="date" id="viewDate" style="padding: 10px; margin: 20px 0;">

                <div class="timeline" id="timeline"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let APP_URL = localStorage.getItem('appUrl') || '';
        let bookings = [];
        let currentBuilding = 'ë³¸ê´€';
        let currentRoom = 'ë³¸ê´€-ë³¸ë‹¹';
        let currentDate = new Date().toISOString().split('T')[0];
        let isAdmin = false;
        let adminDate = new Date().toISOString().split('T')[0];

        // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (ì—¬ê¸°ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”!)
        const ADMIN_PASSWORD = '1972';

        const rooms = {
            'ë³¸ê´€': [
                { id: 'ë³¸ê´€-ë³¸ë‹¹', name: 'ë³¸ë‹¹' },
                { id: 'ë³¸ê´€-ìëª¨ì‹¤', name: 'ìëª¨ì‹¤' },
                { id: 'ë³¸ê´€-êµíšŒì‹ë‹¹', name: 'êµíšŒ ì‹ë‹¹' },
                { id: 'ë³¸ê´€-ì˜ì ‘ì‹¤', name: 'ì˜ì ‘ì‹¤(2-1êµì‹¤)' },
                { id: 'ë³¸ê´€-ê¸°ë„ì‹¤', name: 'ê¸°ë„ì‹¤(2-2êµì‹¤)' },
                { id: 'ë³¸ê´€-êµìœ¡ìœ„ì›íšŒì‹¤', name: 'êµìœ¡ìœ„ì›íšŒì‹¤' },
                { id: 'ë³¸ê´€-2ì¸µì„¸ë¯¸ë‚˜ì‹¤', name: '2ì¸µ ì„¸ë¯¸ë‚˜ì‹¤' },
                { id: 'ë³¸ê´€-ì•…ê¸°ì—°ìŠµì‹¤', name: 'ì•…ê¸°ì—°ìŠµì‹¤' },
                { id: 'ë³¸ê´€-ì˜ì•„ë¶€ì‹¤', name: 'ì˜ì•„ë¶€ì‹¤' }
            ],
            'ì„¼í„°ìœ„ë“œ': [
                { id: 'ì„¼í„°ìœ„ë“œ-ì§€í•˜ì½˜ì„œíŠ¸í™€', name: 'ì§€í•˜ ì½˜ì„œíŠ¸í™€' },
                { id: 'ì„¼í„°ìœ„ë“œ-2ì¸µ', name: '2ì¸µ' },
                { id: 'ì„¼í„°ìœ„ë“œ-3ì¸µì„¸ë¯¸ë‚˜ì‹¤1', name: '3ì¸µ ì„¸ë¯¸ë‚˜ì‹¤1' },
                { id: 'ì„¼í„°ìœ„ë“œ-3ì¸µì„¸ë¯¸ë‚˜ì‹¤2', name: '3ì¸µ ì„¸ë¯¸ë‚˜ì‹¤2' },
                { id: 'ì„¼í„°ìœ„ë“œ-3ì¸µì„¸ë¯¸ë‚˜ì‹¤3', name: '3ì¸µ ì„¸ë¯¸ë‚˜ì‹¤3' },
                { id: 'ì„¼í„°ìœ„ë“œ-3ì¸µì„¸ë¯¸ë‚˜ì‹¤4', name: '3ì¸µ ì„¸ë¯¸ë‚˜ì‹¤4' },
                { id: 'ì„¼í„°ìœ„ë“œ-3ì¸µì„¸ë¯¸ë‚˜ì‹¤5', name: '3ì¸µ ì„¸ë¯¸ë‚˜ì‹¤5' },
                { id: 'ì„¼í„°ìœ„ë“œ-5ì¸µìœ ì¹˜ë¶€ì‹¤', name: '5ì¸µ(ìœ ì¹˜ë¶€ì‹¤)' },
                { id: 'ì„¼í„°ìœ„ë“œ-6ì¸µì´ˆë“±ë¶€ì‹¤', name: '6ì¸µ(ì´ˆë“±ë¶€ì‹¤)' },
                { id: 'ì„¼í„°ìœ„ë“œ-7ì¸µìœ ë…„ë¶€ì‹¤', name: '7ì¸µ(ìœ ë…„ë¶€ì‹¤)' }
            ]
        };

        const timeSlots = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00'];

        // Initialize
        window.onload = function() {
            document.getElementById('date').value = currentDate;
            document.getElementById('viewDate').value = currentDate;
            document.getElementById('viewDate').addEventListener('change', (e) => {
                currentDate = e.target.value;
                renderTimeline();
            });

            // Admin date initialization
            const adminDateInput = document.getElementById('adminDate');
            if (adminDateInput) {
                adminDateInput.value = adminDate;
                adminDateInput.addEventListener('change', (e) => {
                    adminDate = e.target.value;
                    renderAdminTimetable();
                });
            }

            if (APP_URL) {
                hideSetup();
                loadData();
            } else {
                showSetup();
            }

            initRooms();
        };

        function showSetup() {
            document.getElementById('setupBox').style.display = 'block';
            document.getElementById('userView').style.display = 'none';
            document.getElementById('adminView').style.display = 'none';
        }

        function hideSetup() {
            document.getElementById('setupBox').style.display = 'none';
            document.getElementById('userView').style.display = 'grid';
        }

        function saveUrl() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url || !url.includes('script.google.com')) {
                alert('ì˜¬ë°”ë¥¸ Google Apps Script URLì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            APP_URL = url;
            localStorage.setItem('appUrl', url);
            hideSetup();
            loadData();
        }

        function initRooms() {
            renderRoomButtons();
        }

        function renderRoomButtons() {
            const container = document.getElementById('roomSelector');
            const roomList = rooms[currentBuilding];
            container.innerHTML = roomList.map((room, i) => 
                `<button class="room-btn ${i === 0 ? 'active' : ''}" onclick="selectRoom('${room.id}')">${room.name}</button>`
            ).join('');
            currentRoom = roomList[0].id;
            renderTimeline();
        }

        function switchBuilding(building) {
            currentBuilding = building;
            document.querySelectorAll('.building-tab').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(building === 'ë³¸ê´€' ? 'ë³¸ê´€' : 'ì„¼í„°ìœ„ë“œ'));
            });
            renderRoomButtons();
        }

        function selectRoom(roomId) {
            currentRoom = roomId;
            document.querySelectorAll('.room-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderTimeline();
        }

        async function loadData() {
            if (!APP_URL) return;

            try {
                const response = await fetch(APP_URL + '?action=getAll');
                const data = await response.json();
                
                console.log('ë¡œë“œëœ ë°ì´í„°:', data);
                
                bookings = Array.isArray(data) ? data : [];
                renderTimeline();
                
                if (isAdmin) {
                    renderAdmin();
                }
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showMessage('error', 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        function renderTimeline() {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';

            timeSlots.forEach(time => {
                const label = document.createElement('div');
                label.className = 'time-label';
                label.textContent = time;
                timeline.appendChild(label);

                const slot = document.createElement('div');
                slot.className = 'time-slot';

                const booking = bookings.find(b => 
                    b.room === currentRoom && 
                    b.date === currentDate && 
                    b.time === time
                );

                if (booking) {
                    slot.classList.add('booked');
                    slot.innerHTML = `
                        <strong>${booking.name}</strong><br>
                        ğŸ“ ${booking.phone}<br>
                        ${booking.purpose ? 'ğŸ“Œ ' + booking.purpose : ''}
                    `;
                } else {
                    slot.textContent = 'ì˜ˆì•½ ê°€ëŠ¥';
                    slot.onclick = () => quickBook(time);
                }

                timeline.appendChild(slot);
            });
        }

        function quickBook(time) {
            document.getElementById('room').value = currentRoom;
            document.getElementById('date').value = currentDate;
            document.getElementById('time').value = time;
            document.getElementById('name').focus();
        }

        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                action: 'add',
                room: document.getElementById('room').value,
                date: document.getElementById('date').value,
                time: document.getElementById('time').value,
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                purpose: document.getElementById('purpose').value
            };

            try {
                const params = new URLSearchParams(formData);
                const response = await fetch(APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });

                const result = await response.json();
                console.log('ì˜ˆì•½ ê²°ê³¼:', result);

                if (result.success) {
                    showMessage('success', result.message);
                    document.getElementById('bookingForm').reset();
                    document.getElementById('date').value = currentDate;
                    await loadData();
                } else {
                    showMessage('error', result.message);
                }
            } catch (error) {
                console.error('ì˜ˆì•½ ì‹¤íŒ¨:', error);
                showMessage('error', 'ì˜ˆì•½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        });

        function showMessage(type, text) {
            const msgId = type === 'success' ? 'successMsg' : 'errorMsg';
            const msg = document.getElementById(msgId);
            msg.textContent = text;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }

        function showPasswordModal() {
            // ì´ë¯¸ ê´€ë¦¬ì ëª¨ë“œë©´ ì‚¬ìš©ì ëª¨ë“œë¡œ ì „í™˜
            if (isAdmin) {
                toggleAdminView();
                return;
            }
            
            document.getElementById('passwordModal').classList.add('active');
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
            setTimeout(() => document.getElementById('passwordInput').focus(), 100);
        }

        function hidePasswordModal() {
            document.getElementById('passwordModal').classList.remove('active');
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
        }

        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            
            if (input === ADMIN_PASSWORD) {
                hidePasswordModal();
                toggleAdminView();
            } else {
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }

        function toggleAdminView() {
            isAdmin = !isAdmin;
            const adminView = document.getElementById('adminView');
            const userView = document.getElementById('userView');
            const toggle = document.getElementById('adminToggle');

            if (isAdmin) {
                adminView.classList.add('active');
                userView.classList.add('hidden');
                toggle.textContent = 'ğŸ‘¥ ì‚¬ìš©ì ëª¨ë“œ';
                toggle.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                toggle.style.color = 'white';
                renderAdmin();
            } else {
                adminView.classList.remove('active');
                userView.classList.remove('hidden');
                toggle.textContent = 'ğŸ‘¤ ê´€ë¦¬ì ëª¨ë“œ';
                toggle.style.background = 'rgba(255,255,255,0.95)';
                toggle.style.color = '#667eea';
            }
        }

        function renderAdmin() {
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const currentHour = now.getHours();
            
            // Calculate current usage
            const currentUsage = bookings.filter(b => {
                if (b.date !== today) return false;
                const bookingHour = parseInt(b.time.split(':')[0]);
                return bookingHour === currentHour;
            });
            
            // Calculate week range
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            const weekBookings = bookings.filter(b => {
                const bookingDate = new Date(b.date);
                return bookingDate >= weekStart && bookingDate <= weekEnd;
            });
            
            // Update stats
            document.getElementById('nowCount').textContent = currentUsage.length;
            document.getElementById('todayCount').textContent = bookings.filter(b => b.date === adminDate).length;
            document.getElementById('weekCount').textContent = weekBookings.length;
            
            // Render heatmap
            renderHeatmap();
        }

        function renderHeatmap() {
            const container = document.getElementById('heatmapContainer');
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const currentHour = now.getHours();
            const isToday = adminDate === today;
            
            // Get all rooms from both buildings
            const allRooms = [...rooms['ë³¸ê´€'], ...rooms['ì„¼í„°ìœ„ë“œ']];
            
            // Filter rooms with bookings on selected date
            const roomsWithBookings = allRooms.filter(room => {
                return bookings.some(b => b.room === room.id && b.date === adminDate);
            });
            
            if (roomsWithBookings.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ì„ íƒí•œ ë‚ ì§œì— ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            // Group by building
            const byBuilding = {
                'ë³¸ê´€': roomsWithBookings.filter(r => r.id.startsWith('ë³¸ê´€-')),
                'ì„¼í„°ìœ„ë“œ': roomsWithBookings.filter(r => r.id.startsWith('ì„¼í„°ìœ„ë“œ-'))
            };
            
            let html = '';
            
            ['ë³¸ê´€', 'ì„¼í„°ìœ„ë“œ'].forEach(building => {
                const buildingRooms = byBuilding[building];
                if (buildingRooms.length === 0) return;
                
                html += `
                    <div class="heatmap-building">
                        <h4>${building === 'ë³¸ê´€' ? 'ğŸ›ï¸ êµíšŒ ë³¸ê´€' : 'ğŸ¢ ì„¼í„°ìœ„ë“œ'}</h4>
                        <div class="heatmap-grid">
                            <!-- Header Row -->
                            <div class="heatmap-header">
                                <div></div>
                                ${timeSlots.map(time => `<div class="heatmap-time">${time.split(':')[0]}</div>`).join('')}
                            </div>
                            
                            <!-- Room Rows -->
                            ${buildingRooms.map(room => {
                                const roomBookings = bookings.filter(b => b.room === room.id && b.date === adminDate);
                                const bookingCount = roomBookings.length;
                                
                                return `
                                    <div class="heatmap-room-label">
                                        <span>${room.name}</span>
                                        <span class="heatmap-room-count">${bookingCount}ê±´</span>
                                    </div>
                                    ${timeSlots.map(time => {
                                        const booking = roomBookings.find(b => b.time === time);
                                        const timeHour = parseInt(time.split(':')[0]);
                                        const isCurrent = isToday && timeHour === currentHour;
                                        
                                        if (booking) {
                                            return `<div class="heatmap-cell booked ${isCurrent ? 'current' : ''}" 
                                                onclick='showBookingDetail(${JSON.stringify(booking)})'>
                                                ${isCurrent ? 'ğŸ”´' : 'â—'}
                                            </div>`;
                                        } else {
                                            return `<div class="heatmap-cell empty"></div>`;
                                        }
                                    }).join('')}
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showBookingDetail(booking) {
            const roomName = getRoomName(booking.room);
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('detailContent');
            
            content.innerHTML = `
                <div class="detail-info">
                    <label>ğŸ“ ì¥ì†Œ</label>
                    <div>${roomName}</div>
                </div>
                <div class="detail-info">
                    <label>ğŸ“… ë‚ ì§œ</label>
                    <div>${booking.date}</div>
                </div>
                <div class="detail-info">
                    <label>â° ì‹œê°„</label>
                    <div>${booking.time} ~ ${getEndTime(booking.time)}</div>
                </div>
                <div class="detail-info">
                    <label>ğŸ‘¤ ì˜ˆì•½ì</label>
                    <div>${booking.name}</div>
                </div>
                <div class="detail-info">
                    <label>ğŸ“ ì—°ë½ì²˜</label>
                    <div>${booking.phone}</div>
                </div>
                ${booking.purpose ? `
                <div class="detail-info">
                    <label>ğŸ“ ëª©ì </label>
                    <div>${booking.purpose}</div>
                </div>
                ` : ''}
                <button class="detail-delete-btn" onclick="deleteBookingFromDetail('${booking.room}', '${booking.date}', '${booking.time}')">
                    ğŸ—‘ï¸ ì˜ˆì•½ ì‚­ì œ
                </button>
            `;
            
            modal.classList.add('active');
        }

        function hideDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        async function deleteBookingFromDetail(room, date, time) {
            hideDetailModal();
            await deleteBooking(room, date, time);
        }

        function getEndTime(startTime) {
            const [hour, minute] = startTime.split(':');
            const endHour = (parseInt(hour) + 1).toString().padStart(2, '0');
            return `${endHour}:${minute}`;
        }

        async function deleteBooking(room, date, time) {
            if (!confirm('ì •ë§ ì´ ì˜ˆì•½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const params = new URLSearchParams({
                    action: 'delete',
                    room: room,
                    date: date,
                    time: time
                });

                const response = await fetch(APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('ì˜ˆì•½ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    await loadData();
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        function getRoomName(roomId) {
            for (const building in rooms) {
                const room = rooms[building].find(r => r.id === roomId);
                if (room) return room.name;
            }
            return roomId;
        }
    </script>
</body>
</html>
